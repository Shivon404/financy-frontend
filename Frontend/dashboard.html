<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FINANCY</title>
    <link rel="stylesheet" href="dashboard.css"> 
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
</head>
<body>
    <div class="navbar">
        <div class="navbar-left">
            <h1>FINANCY</h1>
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchPage('dashboard')">Dashboard</button>
                <button class="nav-tab" onclick="switchPage('analytics')">Analytics</button>
                <button class="nav-tab" onclick="switchPage('goals')">Goals</button>
            </div>
        </div>
        <div class="user-info">
            <button class="theme-toggle" onclick="toggleTheme()">üåô</button>
            <span id="userName" class="user-name-btn" onclick="openProfileModal()">Loading...</span>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="container">
        <!-- Dashboard Page -->
        <div id="dashboardPage" class="page active">
            <div class="summary-cards">
                <div class="card allowance">
                    <h3>Monthly Allowance 
                        <button class="btn-edit" onclick="openAllowanceModal()" title="Edit Allowance">‚úèÔ∏è</button>
                    </h3>
                    <div class="amount" id="allowanceAmount">‚Ç±0.00</div>
                    <div class="trend" id="allowanceTrend"></div>
                </div>
                <div class="card spent">
                    <h3>Total Spent</h3>
                    <div class="amount" id="spentAmount">‚Ç±0.00</div>
                    <div class="trend" id="spentTrend"></div>
                </div>
                <div class="card remaining">
                    <h3>Remaining</h3>
                    <div class="amount" id="remainingAmount"  style="color: blue" >‚Ç±0.00</div>
                    <div class="trend" id="remainingTrend"></div>
                </div>
                <div class="card">
                    <h3>Avg Daily Spending</h3>
                    <div class="amount" id="avgDailySpending">‚Ç±0.00</div>
                    <div class="trend" id="dailyTrend"></div>
                </div>
            </div>

            <div class="section">
                <h2>
                    Budget Overview
                    <button class="btn" onclick="openBudgetModal()">Set Budget</button>
                </h2>
                <div id="budgetList"></div>
            </div>

            <div class="section">
                <h2>
                    Recent Expenses
                    <button class="btn" onclick="openExpenseModal()">Add Expense</button>
                </h2>
                <div class="filter-tabs">
                    <button class="filter-tab active" onclick="filterExpenses('all')">All</button>
                    <button class="filter-tab" onclick="filterExpenses('today')">Today</button>
                    <button class="filter-tab" onclick="filterExpenses('week')">This Week</button>
                    <button class="filter-tab" onclick="filterExpenses('month')">This Month</button>
                </div>
                <div id="expenseList"></div>
            </div>
        </div>

        <!-- Analytics Page -->
        <div id="analyticsPage" class="page">
            <div class="section">
                <h2>Spending Analytics</h2>
                <div class="stats-grid">
                    <div class="chart-container">
                        <canvas id="categoryChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>Smart Insights</h2>
                <div id="insightsList"></div>
            </div>

            <div class="section">
                <h2>Monthly Comparison</h2>
                <div class="chart-container" style="height: 400px;">
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Goals Page -->
        <div id="goalsPage" class="page">
            <div class="section">
                <h2>
                    Savings Goals
                    <button class="btn" onclick="openGoalModal()">Add Goal</button>
                </h2>
                <div id="goalsList"></div>
            </div>
        </div>
    </div>

    <!-- Modals (keeping all existing modals) -->
    <div id="expenseModal" class="modal">
        <div class="modal-content">
            <h2 id="expenseModalTitle">Add Expense</h2>
            <div class="form-group">
                <label>Category</label>
                <select id="expenseCategory"></select>
            </div>
            <div class="form-group">
                <label>Amount (‚Ç±)</label>
                <input type="number" id="expenseAmount" step="0.01" placeholder="100.00" />
            </div>
            <div class="form-group">
                <label>Date</label>
                <input type="date" id="expenseDate" />
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="expenseDescription" placeholder="What did you buy?"></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeExpenseModal()">Cancel</button>
                <button class="btn" onclick="saveExpense()">Save</button>
            </div>
        </div>
    </div>

    <div id="budgetModal" class="modal">
        <div class="modal-content">
            <h2>Set Budget</h2>
            <div class="form-group">
                <label>Category</label>
                <select id="budgetCategory"></select>
            </div>
            <div class="form-group">
                <label>Budget Limit (‚Ç±)</label>
                <input type="number" id="budgetLimit" step="0.01" placeholder="1000.00" />
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeBudgetModal()">Cancel</button>
                <button class="btn" onclick="saveBudget()">Save</button>
            </div>
        </div>
    </div>

    <div id="allowanceModal" class="modal">
        <div class="modal-content">
            <h2>Edit Monthly Allowance</h2>
            <div class="form-group">
                <label>Current Allowance: <strong id="currentAllowance">‚Ç±0.00</strong></label>
            </div>
            <div class="form-group">
                <label>New Monthly Allowance (‚Ç±)</label>
                <input type="number" id="newAllowance" step="0.01" placeholder="5000.00" />
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeAllowanceModal()">Cancel</button>
                <button class="btn" onclick="saveAllowance()">Update</button>
            </div>
        </div>
    </div>

    <div id="goalModal" class="modal">
        <div class="modal-content">
            <h2 id="goalModalTitle">Add Savings Goal</h2>
            <div class="form-group">
                <label>Goal Name</label>
                <input type="text" id="goalName" placeholder="New Laptop" />
            </div>
            <div class="form-group">
                <label>Target Amount (‚Ç±)</label>
                <input type="number" id="goalTarget" step="0.01" placeholder="15000.00" />
            </div>
            <div class="form-group">
                <label>Target Date</label>
                <input type="date" id="goalDate" />
            </div>
            <div class="form-group">
                <label>Current Savings (‚Ç±)</label>
                <input type="number" id="goalCurrent" step="0.01" placeholder="0.00" value="0" />
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeGoalModal()">Cancel</button>
                <button class="btn" onclick="saveGoal()">Save</button>
            </div>
        </div>
    </div>

    <div id="profileModal" class="modal">
        <div class="modal-content">
            <h2>üë§ My Profile</h2>
            <div style="text-align: center; margin-bottom: 30px;">
                <div style="width: 100px; height: 100px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--secondary)); display: inline-flex; align-items: center; justify-content: center; margin: 0 auto;">
                    <span id="profileInitials" style="font-size: 36px; font-weight: bold; color: white;">JD</span>
                </div>
            </div>
            <div style="padding: 15px 0; border-bottom: 1px solid rgba(102, 126, 234, 0.2);">
                <label style="display: block; font-size: 12px; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 5px; font-weight: 600;">Full Name</label>
                <div id="profileFullName" style="font-size: 16px; color: var(--text-primary); font-weight: 500;">-</div>
            </div>
            <div style="padding: 15px 0; border-bottom: 1px solid rgba(102, 126, 234, 0.2);">
                <label style="display: block; font-size: 12px; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 5px; font-weight: 600;">Email</label>
                <div id="profileEmail" style="font-size: 16px; color: var(--text-primary); font-weight: 500;">-</div>
            </div>
            <div style="padding: 15px 0; border-bottom: 1px solid rgba(102, 126, 234, 0.2);">
                <label style="display: block; font-size: 12px; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 5px; font-weight: 600;">Student ID</label>
                <div id="profileStudentId" style="font-size: 16px; color: var(--text-primary); font-weight: 500;">-</div>
            </div>
            <div style="padding: 15px 0; border-bottom: 1px solid rgba(102, 126, 234, 0.2);">
                <label style="display: block; font-size: 12px; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 5px; font-weight: 600;">Monthly Allowance</label>
                <div id="profileAllowance" style="font-size: 16px; color: var(--text-primary); font-weight: 500;">-</div>
            </div>
            <div style="padding: 15px 0;">
                <label style="display: block; font-size: 12px; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 5px; font-weight: 600;">Member Since</label>
                <div id="profileMemberSince" style="font-size: 16px; color: var(--text-primary); font-weight: 500;">-</div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;">
                <div style="background: var(--bg-main); padding: 20px; border-radius: 10px; text-align: center;">
                    <div id="totalExpensesCount" style="font-size: 32px; font-weight: bold; color: var(--primary); margin-bottom: 5px;">0</div>
                    <div style="font-size: 13px; color: var(--text-secondary);">Total Expenses</div>
                </div>
                <div style="background: var(--bg-main); padding: 20px; border-radius: 10px; text-align: center;">
                    <div id="totalBudgetsCount" style="font-size: 32px; font-weight: bold; color: var(--primary); margin-bottom: 5px;">0</div>
                    <div style="font-size: 13px; color: var(--text-secondary);">Active Budgets</div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn" onclick="closeProfileModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:5290/api';
        let currentUser = null;
        let categories = [];
        let currentExpenseId = null;
        let currentBudgetId = null;
        let currentGoalId = null;
        let allExpenses = [];
        let allBudgets = [];
        let savingsGoals = [];
        let categoryChart, trendChart, monthlyChart;
        let currentFilter = 'all';

        if (!localStorage.getItem('user')) {
            window.location.href = 'index.html';
        } else {
            currentUser = JSON.parse(localStorage.getItem('user'));
            init();
        }

        async function init() {
            document.getElementById('userName').textContent = currentUser.fullName;
            document.getElementById('allowanceAmount').textContent = `‚Ç±${currentUser.monthlyAllowance.toFixed(2)}`;
            
            // Load theme preference
            const isDark = localStorage.getItem('darkMode') === 'true';
            if (isDark) {
                document.body.classList.add('dark-mode');
                document.querySelector('.theme-toggle').textContent = '‚òÄÔ∏è';
            }
            
            await loadCategories();
            await loadExpenses();
            await loadBudgets();
            await loadGoals();
            calculateSummary();
            initCharts();
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark);
            document.querySelector('.theme-toggle').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            
            // Update charts
            if (categoryChart) updateChartTheme();
        }

        function switchPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            
            document.getElementById(`${page}Page`).classList.add('active');
            event.target.classList.add('active');
            
            if (page === 'analytics') {
                setTimeout(() => {
                    updateAnalytics();
                }, 100);
            } else if (page === 'goals') {
                displayGoals();
            }
        }

        async function loadCategories() {
            try {
                const response = await fetch(`${API_URL}/expense/categories`);
                const data = await response.json();
                if (data.success) {
                    categories = data.categories;
                    populateCategorySelects();
                }
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        function populateCategorySelects() {
            const expenseSelect = document.getElementById('expenseCategory');
            const budgetSelect = document.getElementById('budgetCategory');
            
            expenseSelect.innerHTML = categories.map(c => 
                `<option value="${c.categoryId}">${c.icon} ${c.categoryName}</option>`
            ).join('');
            
            budgetSelect.innerHTML = categories.map(c => 
                `<option value="${c.categoryId}">${c.icon} ${c.categoryName}</option>`
            ).join('');
        }

        async function loadExpenses() {
            try {
                const response = await fetch(`${API_URL}/expense/${currentUser.userId}`);
                const data = await response.json();
                
                if (data.success) {
                    allExpenses = data.expenses;
                    displayExpenses();
                }
            } catch (error) {
                console.error('Error loading expenses:', error);
            }
        }

        function filterExpenses(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            displayExpenses();
        }

        function displayExpenses() {
            const expenseList = document.getElementById('expenseList');
            let filtered = [...allExpenses];
            
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            if (currentFilter === 'today') {
                filtered = filtered.filter(e => {
                    const expDate = new Date(e.expenseDate);
                    return expDate >= today;
                });
            } else if (currentFilter === 'week') {
                const weekAgo = new Date(today);
                weekAgo.setDate(weekAgo.getDate() - 7);
                filtered = filtered.filter(e => new Date(e.expenseDate) >= weekAgo);
            } else if (currentFilter === 'month') {
                const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                filtered = filtered.filter(e => new Date(e.expenseDate) >= monthStart);
            }
            
            if (filtered.length === 0) {
                expenseList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìù</div>
                        <p>No expenses found for this period.</p>
                    </div>
                `;
                return;
            }
            
            expenseList.innerHTML = filtered.slice(0, 20).map(expense => `
                <div class="expense-item">
                    <div class="expense-info">
                        <div class="expense-icon">${expense.categoryIcon}</div>
                        <div class="expense-details">
                            <h4>${expense.categoryName}</h4>
                            <p>${expense.description || 'No description'} ‚Ä¢ ${formatDate(expense.expenseDate)}</p>
                        </div>
                    </div>
                    <div class="expense-amount">‚Ç±${expense.amount.toFixed(2)}</div>
                    <div class="expense-actions">
                        <button class="btn btn-secondary" onclick="editExpense(${expense.expenseId})">Edit</button>
                        <button class="btn btn-danger" onclick="deleteExpense(${expense.expenseId})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        async function loadBudgets() {
            try {
                const response = await fetch(`${API_URL}/budget/${currentUser.userId}`);
                const data = await response.json();
                
                if (data.success) {
                    allBudgets = data.budgets;
                    displayBudgets();
                }
            } catch (error) {
                console.error('Error loading budgets:', error);
            }
        }

        function displayBudgets() {
            const budgetList = document.getElementById('budgetList');
            
            if (allBudgets.length === 0) {
                budgetList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üí∞</div>
                        <p>No budgets set yet. Create a budget to track your spending!</p>
                    </div>
                `;
                return;
            }
            
            budgetList.innerHTML = allBudgets.map(budget => {
                const percentage = Math.min(budget.spentPercentage, 100);
                const statusClass = budget.status === 'Over Budget' ? 'over' : 
                                  budget.status === 'Warning' ? 'warning' : 'on-track';
                
                return `
                    <div class="budget-item">
                        <div class="budget-header">
                            <div class="budget-name">
                                <span style="font-size: 24px">${budget.categoryIcon}</span>
                                ${budget.categoryName}
                            </div>
                            <div class="budget-status ${statusClass}">${budget.status}</div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill ${statusClass}" style="width: ${percentage}%"></div>
                        </div>
                        <div class="budget-info">
                            <span>Spent: ‚Ç±${budget.spentAmount.toFixed(2)} / ‚Ç±${budget.budgetLimit.toFixed(2)}</span>
                            <span>Remaining: ‚Ç±${budget.remainingAmount.toFixed(2)}</span>
                        </div>
                        <div class="budget-actions">
                            <button class="btn btn-secondary" onclick="editBudget(${budget.budgetId}, ${budget.categoryId}, ${budget.budgetLimit})">Edit</button>
                            <button class="btn btn-danger" onclick="deleteBudget(${budget.budgetId})">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function calculateSummary() {
            const now = new Date();
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            
            const thisMonthExpenses = allExpenses.filter(e => 
                new Date(e.expenseDate) >= monthStart
            );
            
            const total = thisMonthExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            const remaining = currentUser.monthlyAllowance - total;
            const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            const avgDaily = total / now.getDate();
            
            document.getElementById('spentAmount').textContent = `‚Ç±${total.toFixed(2)}`;
            document.getElementById('remainingAmount').textContent = `‚Ç±${remaining.toFixed(2)}`;
            document.getElementById('avgDailySpending').textContent = `‚Ç±${avgDaily.toFixed(2)}`;
            
            // Calculate trends
            const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            const lastMonthEnd = new Date(now.getFullYear(), now.getMonth(), 0);
            const lastMonthExpenses = allExpenses.filter(e => {
                const d = new Date(e.expenseDate);
                return d >= lastMonth && d <= lastMonthEnd;
            });
            const lastMonthTotal = lastMonthExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            
            const change = ((total - lastMonthTotal) / (lastMonthTotal || 1)) * 100;
            const trendClass = change > 0 ? 'down' : 'up';
            const trendIcon = change > 0 ? 'üìà' : 'üìâ';
            
            document.getElementById('spentTrend').innerHTML = `${trendIcon} ${Math.abs(change).toFixed(1)}% vs last month`;
            document.getElementById('spentTrend').className = `trend ${trendClass}`;
        }

        async function loadGoals() {
            // Load from localStorage for now
            const stored = localStorage.getItem(`goals_${currentUser.userId}`);
            savingsGoals = stored ? JSON.parse(stored) : [];
            displayGoals();
        }

        function displayGoals() {
            const goalsList = document.getElementById('goalsList');
            
            if (savingsGoals.length === 0) {
                goalsList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üéØ</div>
                        <p>No savings goals yet. Set a goal to stay motivated!</p>
                    </div>
                `;
                return;
            }
            
            goalsList.innerHTML = savingsGoals.map((goal, index) => {
                const percentage = Math.min((goal.currentAmount / goal.targetAmount) * 100, 100);
                const remaining = goal.targetAmount - goal.currentAmount;
                const daysLeft = Math.ceil((new Date(goal.targetDate) - new Date()) / (1000 * 60 * 60 * 24));
                
                return `
                    <div class="goal-card">
                        <div class="goal-header">
                            <div class="goal-name">üéØ ${goal.name}</div>
                            <div class="goal-amount">‚Ç±${goal.currentAmount.toFixed(2)} / ‚Ç±${goal.targetAmount.toFixed(2)}</div>
                        </div>
                        <div class="goal-progress">
                            <div class="goal-progress-text">
                                <span>${percentage.toFixed(1)}% Complete</span>
                                <span>${daysLeft} days left</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${percentage}%"></div>
                            </div>
                            <div class="goal-progress-text" style="margin-top: 10px;">
                                <span>Remaining: ‚Ç±${remaining.toFixed(2)}</span>
                                <span>Target: ${formatDate(goal.targetDate)}</span>
                            </div>
                        </div>
                        <div class="budget-actions" style="margin-top: 15px;">
                            <button class="btn" onclick="updateGoalProgress(${index})">Add Savings</button>
                            <button class="btn btn-secondary" onclick="editGoal(${index})">Edit</button>
                            <button class="btn btn-danger" onclick="deleteGoal(${index})">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function initCharts() {
            const isDark = document.body.classList.contains('dark-mode');
            const textColor = isDark ? '#eee' : '#333';
            const gridColor = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
            
            Chart.defaults.color = textColor;
            Chart.defaults.borderColor = gridColor;
        }

        function updateAnalytics() {
            updateCategoryChart();
            updateTrendChart();
            updateMonthlyChart();
            generateInsights();
        }

        function updateCategoryChart() {
            const ctx = document.getElementById('categoryChart');
            if (!ctx) return;
            
            const now = new Date();
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            const thisMonthExpenses = allExpenses.filter(e => new Date(e.expenseDate) >= monthStart);
            
            const categoryTotals = {};
            thisMonthExpenses.forEach(exp => {
                categoryTotals[exp.categoryName] = (categoryTotals[exp.categoryName] || 0) + exp.amount;
            });
            
            const labels = Object.keys(categoryTotals);
            const data = Object.values(categoryTotals);
            
            if (categoryChart) categoryChart.destroy();
            
            categoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#667eea', '#764ba2', '#f093fb', '#4facfe',
                            '#43e97b', '#fa709a', '#fee140', '#30cfd0'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        title: { display: true, text: 'Spending by Category' }
                    }
                }
            });
        }

        function updateTrendChart() {
            const ctx = document.getElementById('trendChart');
            if (!ctx) return;
            
            const last7Days = [];
            const amounts = [];
            const now = new Date();
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date(now);
                date.setDate(date.getDate() - i);
                last7Days.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                
                const dayTotal = allExpenses
                    .filter(e => {
                        const expDate = new Date(e.expenseDate);
                        return expDate.toDateString() === date.toDateString();
                    })
                    .reduce((sum, e) => sum + e.amount, 0);
                amounts.push(dayTotal);
            }
            
            if (trendChart) trendChart.destroy();
            
            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last7Days,
                    datasets: [{
                        label: 'Daily Spending',
                        data: amounts,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'Last 7 Days Trend' }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function updateMonthlyChart() {
            const ctx = document.getElementById('monthlyChart');
            if (!ctx) return;
            
            const monthlyData = {};
            allExpenses.forEach(exp => {
                const date = new Date(exp.expenseDate);
                const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                monthlyData[key] = (monthlyData[key] || 0) + exp.amount;
            });
            
            const sortedMonths = Object.keys(monthlyData).sort().slice(-6);
            const labels = sortedMonths.map(m => {
                const [year, month] = m.split('-');
                return new Date(year, month - 1).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
            });
            const data = sortedMonths.map(m => monthlyData[m]);
            
            if (monthlyChart) monthlyChart.destroy();
            
            monthlyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Monthly Spending',
                        data: data,
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: '#667eea',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'Monthly Spending Comparison' }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function generateInsights() {
            const insights = [];
            const now = new Date();
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            const thisMonthExpenses = allExpenses.filter(e => new Date(e.expenseDate) >= monthStart);
            const total = thisMonthExpenses.reduce((sum, e) => sum + e.amount, 0);
            
            // Insight 1: Budget status
            const percentSpent = (total / currentUser.monthlyAllowance) * 100;
            if (percentSpent > 90) {
                insights.push({
                    icon: '‚ö†Ô∏è',
                    title: 'Budget Alert',
                    message: `You've spent ${percentSpent.toFixed(1)}% of your monthly allowance. Consider reducing expenses.`
                });
            } else if (percentSpent < 50 && now.getDate() > 20) {
                insights.push({
                    icon: '‚ú®',
                    title: 'Great Job!',
                    message: `You're on track! Only ${percentSpent.toFixed(1)}% of your budget used.`
                });
            }
            
            // Insight 2: Top category
            const categoryTotals = {};
            thisMonthExpenses.forEach(exp => {
                categoryTotals[exp.categoryName] = (categoryTotals[exp.categoryName] || 0) + exp.amount;
            });
            const topCategory = Object.entries(categoryTotals).sort((a, b) => b[1] - a[1])[0];
            if (topCategory) {
                insights.push({
                    icon: 'üìä',
                    title: 'Top Spending Category',
                    message: `${topCategory[0]} accounts for ‚Ç±${topCategory[1].toFixed(2)} (${((topCategory[1]/total)*100).toFixed(1)}%) of your spending.`
                });
            }
            
            // Insight 3: Savings potential
            const remaining = currentUser.monthlyAllowance - total;
            const daysLeft = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate() - now.getDate();
            if (remaining > 0 && daysLeft > 0) {
                insights.push({
                    icon: 'üí∞',
                    title: 'Savings Potential',
                    message: `You have ‚Ç±${remaining.toFixed(2)} remaining. That's ‚Ç±${(remaining/daysLeft).toFixed(2)} per day for ${daysLeft} days.`
                });
            }
            
            const insightsList = document.getElementById('insightsList');
            insightsList.innerHTML = insights.map(insight => `
                <div class="insight-card">
                    <h3>${insight.icon} ${insight.title}</h3>
                    <p>${insight.message}</p>
                </div>
            `).join('');
        }

        function updateChartTheme() {
            const isDark = document.body.classList.contains('dark-mode');
            const textColor = isDark ? '#eee' : '#333';
            const gridColor = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
            
            Chart.defaults.color = textColor;
            Chart.defaults.borderColor = gridColor;
            
            if (categoryChart) categoryChart.destroy();
            if (trendChart) trendChart.destroy();
            if (monthlyChart) monthlyChart.destroy();
            
            updateAnalytics();
        }

        // Modal functions
        function openExpenseModal() {
            currentExpenseId = null;
            document.getElementById('expenseModalTitle').textContent = 'Add Expense';
            document.getElementById('expenseAmount').value = '';
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('expenseDescription').value = '';
            document.getElementById('expenseModal').classList.add('active');
        }

        function closeExpenseModal() {
            document.getElementById('expenseModal').classList.remove('active');
        }

        async function saveExpense() {
            const categoryId = parseInt(document.getElementById('expenseCategory').value);
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const date = document.getElementById('expenseDate').value;
            const description = document.getElementById('expenseDescription').value;

            if (!amount || !date) {
                alert('Please fill in all required fields');
                return;
            }

            try {
                const expense = {
                    userId: currentUser.userId,
                    categoryId,
                    amount,
                    expenseDate: date,
                    description
                };

                const url = currentExpenseId ? `${API_URL}/expense` : `${API_URL}/expense`;
                const method = currentExpenseId ? 'PUT' : 'POST';
                
                if (currentExpenseId) expense.expenseId = currentExpenseId;

                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(expense)
                });

                const data = await response.json();
                
                if (data.success) {
                    closeExpenseModal();
                    await loadExpenses();
                    await loadBudgets();
                    calculateSummary();
                } else {
                    alert(data.message);
                }
            } catch (error) {
                alert('Error saving expense!');
            }
        }

        async function editExpense(expenseId) {
            const expense = allExpenses.find(e => e.expenseId === expenseId);
            if (expense) {
                currentExpenseId = expenseId;
                document.getElementById('expenseModalTitle').textContent = 'Edit Expense';
                document.getElementById('expenseCategory').value = expense.categoryId;
                document.getElementById('expenseAmount').value = expense.amount;
                document.getElementById('expenseDate').value = expense.expenseDate.split('T')[0];
                document.getElementById('expenseDescription').value = expense.description || '';
                document.getElementById('expenseModal').classList.add('active');
            }
        }

        async function deleteExpense(expenseId) {
            if (!confirm('Are you sure you want to delete this expense?')) return;

            try {
                const response = await fetch(`${API_URL}/expense/${expenseId}/${currentUser.userId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                
                if (data.success) {
                    await loadExpenses();
                    await loadBudgets();
                    calculateSummary();
                } else {
                    alert(data.message);
                }
            } catch (error) {
                alert('Error deleting expense!');
            }
        }

        function openBudgetModal() {
            currentBudgetId = null;
            document.getElementById('budgetCategory').disabled = false;
            document.getElementById('budgetLimit').value = '';
            document.getElementById('budgetModal').querySelector('h2').textContent = 'Set Budget';
            document.getElementById('budgetModal').classList.add('active');
        }

        function closeBudgetModal() {
            document.getElementById('budgetModal').classList.remove('active');
        }

        async function saveBudget() {
            const categoryId = parseInt(document.getElementById('budgetCategory').value);
            const limit = parseFloat(document.getElementById('budgetLimit').value);

            if (!limit || limit <= 0) {
                alert('Please enter a valid budget amount');
                return;
            }

            try {
                const now = new Date();
                const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
                const formattedDate = firstDay.toISOString().split('T')[0];

                const budget = {
                    userId: currentUser.userId,
                    categoryId,
                    budgetLimit: limit,
                    month: formattedDate
                };

                if (currentBudgetId) budget.budgetId = currentBudgetId;

                const response = await fetch(`${API_URL}/budget`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(budget)
                });

                const data = await response.json();
                
                if (data.success) {
                    closeBudgetModal();
                    await loadBudgets();
                    alert(currentBudgetId ? 'Budget updated successfully!' : 'Budget created successfully!');
                } else {
                    alert(data.message);
                }
            } catch (error) {
                alert('Error saving budget!');
            }
        }

        function editBudget(budgetId, categoryId, currentLimit) {
            currentBudgetId = budgetId;
            document.getElementById('budgetCategory').value = categoryId;
            document.getElementById('budgetCategory').disabled = true;
            document.getElementById('budgetLimit').value = currentLimit;
            document.getElementById('budgetModal').querySelector('h2').textContent = 'Edit Budget';
            document.getElementById('budgetModal').classList.add('active');
        }

        async function deleteBudget(budgetId) {
            if (!confirm('Are you sure you want to delete this budget?')) return;

            try {
                const response = await fetch(`${API_URL}/budget/${budgetId}/${currentUser.userId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                
                if (data.success) {
                    await loadBudgets();
                    alert('Budget deleted successfully!');
                } else {
                    alert(data.message);
                }
            } catch (error) {
                alert('Error deleting budget!');
            }
        }

        function openAllowanceModal() {
            document.getElementById('currentAllowance').textContent = `‚Ç±${currentUser.monthlyAllowance.toFixed(2)}`;
            document.getElementById('newAllowance').value = currentUser.monthlyAllowance;
            document.getElementById('allowanceModal').classList.add('active');
        }

        function closeAllowanceModal() {
            document.getElementById('allowanceModal').classList.remove('active');
        }

        async function saveAllowance() {
            const newAllowance = parseFloat(document.getElementById('newAllowance').value);

            if (!newAllowance || newAllowance <= 0) {
                alert('Please enter a valid amount');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/auth/update-allowance`, {
                   
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: currentUser.userId,
                        monthlyAllowance: newAllowance
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    currentUser.monthlyAllowance = newAllowance;
                    localStorage.setItem('user', JSON.stringify(currentUser));
                    document.getElementById('allowanceAmount').textContent = `‚Ç±${newAllowance.toFixed(2)}`;
                    closeAllowanceModal();
                    calculateSummary();
                    alert('Allowance updated successfully!');
                } else {
                    alert(data.message);
                }
            } catch (error) {
                alert('Error updating allowance!');
            }
        }

        function openGoalModal() {
            currentGoalId = null;
            document.getElementById('goalModalTitle').textContent = 'Add Savings Goal';
            document.getElementById('goalName').value = '';
            document.getElementById('goalTarget').value = '';
            document.getElementById('goalDate').value = '';
            document.getElementById('goalCurrent').value = '0';
            document.getElementById('goalModal').classList.add('active');
        }

        function closeGoalModal() {
            document.getElementById('goalModal').classList.remove('active');
        }

        function saveGoal() {
            const name = document.getElementById('goalName').value;
            const target = parseFloat(document.getElementById('goalTarget').value);
            const date = document.getElementById('goalDate').value;
            const current = parseFloat(document.getElementById('goalCurrent').value) || 0;

            if (!name || !target || !date) {
                alert('Please fill in all required fields');
                return;
            }

            const goal = { name, targetAmount: target, targetDate: date, currentAmount: current };

            if (currentGoalId !== null) {
                savingsGoals[currentGoalId] = goal;
            } else {
                savingsGoals.push(goal);
            }

            localStorage.setItem(`goals_${currentUser.userId}`, JSON.stringify(savingsGoals));
            closeGoalModal();
            displayGoals();
        }

        function editGoal(index) {
            currentGoalId = index;
            const goal = savingsGoals[index];
            document.getElementById('goalModalTitle').textContent = 'Edit Savings Goal';
            document.getElementById('goalName').value = goal.name;
            document.getElementById('goalTarget').value = goal.targetAmount;
            document.getElementById('goalDate').value = goal.targetDate.split('T')[0];
            document.getElementById('goalCurrent').value = goal.currentAmount;
            document.getElementById('goalModal').classList.add('active');
        }

        function deleteGoal(index) {
            if (!confirm('Are you sure you want to delete this goal?')) return;
            savingsGoals.splice(index, 1);
            localStorage.setItem(`goals_${currentUser.userId}`, JSON.stringify(savingsGoals));
            displayGoals();
        }

        function updateGoalProgress(index) {
            const amount = prompt('Enter amount to add to savings:');
            if (amount && !isNaN(amount)) {
                const addAmount = parseFloat(amount);
                savingsGoals[index].currentAmount += addAmount;
                localStorage.setItem(`goals_${currentUser.userId}`, JSON.stringify(savingsGoals));
                displayGoals();
            }
        }

        function openProfileModal() {
            // Set profile data
            document.getElementById('profileFullName').textContent = currentUser.fullName;
            document.getElementById('profileEmail').textContent = currentUser.email;
            document.getElementById('profileStudentId').textContent = currentUser.studentId;
            document.getElementById('profileAllowance').textContent = `‚Ç±${currentUser.monthlyAllowance.toFixed(2)}`;
            
            // Set initials
            const initials = currentUser.fullName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
            document.getElementById('profileInitials').textContent = initials;
            
            // Set member since (using current date as placeholder)
            const memberSince = new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            document.getElementById('profileMemberSince').textContent = memberSince;
            
            // Set stats
            document.getElementById('totalExpensesCount').textContent = allExpenses.length;
            document.getElementById('totalBudgetsCount').textContent = allBudgets.length;
            
            document.getElementById('profileModal').classList.add('active');
        }

        function closeProfileModal() {
            document.getElementById('profileModal').classList.remove('active');
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;
            
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('user');
                window.location.href = 'index.html';
            }
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        }
    </script>
</body>
</html>